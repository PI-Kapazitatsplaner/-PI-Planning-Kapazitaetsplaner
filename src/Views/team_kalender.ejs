<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" href="/Images/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="header.css">
  <link rel="stylesheet" href="numberInput.css">
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="team.css">
  <script src="controller.js"></script>
  <title>Team Kalender</title>
</head>

<body id="body" class="content">
  <%- include('header') %>
  <div class="mainContent" id="mainContent">
    <div class="titleGrid">
      <div class="number-input year-select">
        <input oninput="updateYear(this)" min="0" name="quantity" max="2100" value="<%- params.year %>" type="number">
        <button class="plus" onclick="this.parentNode.querySelector('input[type=number]').stepUp(); updateYear(this.parentNode.querySelector('input[type=number]'))"></button>
        <button class="minus" onclick="this.parentNode.querySelector('input[type=number]').stepDown(); updateYear(this.parentNode.querySelector('input[type=number]'))"></button>
      </div>
      <div class="titles">
        <a <% if(params.pi==1){%> style="font-weight: bold;" <% } %> class="title" href="/team_kalender/<%- params.year %>/PI-01">PI-01</a>
        <a <% if(params.pi==2){%> style="font-weight: bold;" <% } %> class="title" href="/team_kalender/<%- params.year %>/PI-02">PI-02</a>
        <a <% if(params.pi==3){%> style="font-weight: bold;" <% } %> class="title" href="/team_kalender/<%- params.year %>/PI-03">PI-03</a>
        <a <% if(params.pi==4){%> style="font-weight: bold;" <% } %> class="title" href="/team_kalender/<%- params.year %>/PI-04">PI-04</a>
      </div>
    </div>
    <% if (piIsDefined) { %>
      <% if (noTeam === false) { %>
      <table cellspacing="0" class="velocityBoard">
        <tbody>
          <tr>
            <th class="name firstElement borderTL">Name</th>
            <th>Sprint 1</th>
            <th>Sprint 2</th>
            <th>Sprint 3</th>
            <th>Sprint 4</th>
            <th>Sprint 5</th>
            <th class="borderTR">Sprint 6</th>
          </tr>
          <% for(const member of teamMembers){ %>
          <tr>
            <td class="text firstElement tooltip">
              <p class="text ttContainer"><%- member.user.firstname + ' ' + member.user.lastname%>
                <span class="tooltiptext">
                  <%- member.user.firstname %> hat ein Pensum von <%- (7 - (member.user.standardAbwesenheiten.length)) * 20 %> % und ist dabei zu <%- member.user.productivityPercentage %>% am Entwickeln
                </span>
              </p>
            </td>
            <% for(const dayInSprint of member.anwesendeTageProSprint){ %>
            <td class="text"><%= dayInSprint%> </td>
            <% } %>
          </tr>
          <% } %>
          <tr>
            <td class="text borderTop firstElement">Totale Tage</td>
            <% for(const tps of tageProSprint){ %>
            <td class="text borderTop"><%= tps %></td>
            <% } %>
          </tr>
          <tr>
            <td class="text firstElement">Kapazität</td>
            <% for(const sp of kapazitaet){ %>
            <td class="text"><%= sp %></td>
            <% } %>
          </tr>
          <tr>
            <td class="text firstElement">Umgesetzte Storypoints</td>
            <% for(let i = 1; i < umgesetzteStorypoints.length + 1; i++){ %>
            <td class="text">
              <form action="/team_kalender/<%- params.year %>/<%- params.pi %>/<%= i %>" method="post">
                <div class="number-input usp-select">
                  <input class="text" step="0.5" min="0" onchange="updateUps(this,<%- umgesetzteStorypoints[i - 1] %>)" name="usp" value="<%- umgesetzteStorypoints[i - 1] %>" type="number">
                  <button type="button" class="plus" onclick="this.parentNode.querySelector('input[type=number]').stepUp(); updateUps(this,<%- umgesetzteStorypoints[i - 1] %>);"></button>
                  <button type="button" class="minus" onclick="this.parentNode.querySelector('input[type=number]').stepDown(); updateUps(this,<%- umgesetzteStorypoints[i - 1] %>);"></button>
                  <button class="save">Save</button>
                </div>
                  <input type="hidden" name="teamId" value="7">
              </form>
            </td>
            <% } %>
          </tr>
          <tr>
            <td class="text firstElement">Velocity</td>
            <% for(let i = 0; i < velocitiesProSprint.length -1 ; i++){ %>
            <td class="text"><%= velocitiesProSprint[i] %>%</td>
            <% } %>
            <td class="text"><%= velocitiesProSprint[velocitiesProSprint.length -1] %>%</td>
          </tr>
          <tr>
            <td style="border: 0;"></td>
            <td style="border: 0;"></td>
            <td style="border: 0;"></td>
            <td style="border: 0;"></td>
            <td style="border: 0;"></td>
            <td class="text">Total Sp:</td>
            <td class="text borderBR"><%- umgesetzteStorypoints.reduce((a, b) => a + b) %></td>
          </tr>
        </tbody>
      </table>
      <% } else{ %>
        <h1 class="text" style="text-align: center;">Du must erst einem Team beitreten!</h1>
      <% } %>
    <% } else{ %>
      <h1 class="text" style="text-align: center;">Für dieses Pi sind keine Daten vorhanden</h1>
    <% } %>
  </div>
</body>
<script>
  function updateYear(yearInput) {
    location.href = "/team_kalender/" + yearInput.value + "/PI-01";
  }

  function updateUps(uspInput, oldUsp) {
    const newUsp = uspInput.parentNode.querySelector('input[type=number]').value;
    if(newUsp != oldUsp){
        uspInput.parentNode.querySelector('button.save').style.visibility = "visible";
    } else {
        uspInput.parentNode.querySelector('button.save').style.visibility = "hidden";
    }
  }
</script>
<%- include('colorScript') %>

</html>